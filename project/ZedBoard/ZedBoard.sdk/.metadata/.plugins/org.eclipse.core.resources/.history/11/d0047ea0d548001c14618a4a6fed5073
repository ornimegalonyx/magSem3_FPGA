#include <mtds.h>
#include <MyDisp.h>
#include <stdint.h>
#include <string.h>
#include "sleep.h"

#include "xil_cache.h"
#include "xparameters.h"

MDFNG rgfng[2];

void setup() {
	bool fStat;

	while (true) {
		fStat = mydisp.begin();
		if (fStat) {
			xil_printf("mydisp.begin() succeeded\n\r");
			break;
		} else {
			xil_printf("mydisp.begin() failed\n\r");
			sleep(1);
		}
	}
}


void paint();
void checkTouch();
void test();

int main() {
	setup();
	while (1) {
		checkTouch();
		paint();
	}
	return 0;
}

void paint() {
//   mydisp.clearDisplay(clrBlack);

	test();
	usleep(100000);
}

void test() {

}

void checkTouch() {
	MTCH mtch;

	if (mtds.GetMsgStatus() == 0) {
		return;
	}

	mtds.GetMsg((MEVT *) &mtch);

	if ((mtch.msg < msgFingerFirst) || (mtch.msg > msgFingerLast)) {
		return;
	}

	if ((mtch.msg >= msgFinger1Down) && (mtch.msg <= msgFinger1Up)) {
		rgfng[0].x = mtch.xco;
		rgfng[0].y = mtch.yco;
		if (mtch.msg == msgFinger1Down) {
			rgfng[0].st = FINGER_DOWN;
		} else if (mtch.msg == msgFinger1Move) {
			rgfng[0].st = FINGER_MOVE;
		} else {
			rgfng[0].st = FINGER_UP;
		}
	}

	if ((mtch.msg >= msgFinger2Down) && (mtch.msg <= msgFinger2Up)) {
		rgfng[1].x = mtch.xco;
		rgfng[1].y = mtch.yco;
		if (mtch.msg == msgFinger2Down) {
			rgfng[1].st = FINGER_DOWN;
		} else if (mtch.msg == msgFinger2Move) {
			rgfng[1].st = FINGER_MOVE;
		} else {
			rgfng[1].st = FINGER_UP;
		}
	}
}
