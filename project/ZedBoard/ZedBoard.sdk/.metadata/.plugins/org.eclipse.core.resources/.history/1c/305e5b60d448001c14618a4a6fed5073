#include <mtds.h>
#include <MyDisp.h>
#include <stdint.h>
#include <string.h>
#include "sleep.h"

#include "xil_cache.h"
#include "xparameters.h"

#define __MTDSTRACE__

void setup() {
	bool fStat;

	while (true) {
		fStat = mydisp.begin();
		if (fStat) {
			xil_printf("mydisp.begin() succeeded\n\r");
			break;
		} else {
			xil_printf("mydisp.begin() failed\n\r");
			sleep(1);
		}
	}
}

void checkTouch() {
	MTCH		mtch;
	int			idBtn;

	/* See if there is anything in the event queue.
	*/
	if (!fInitialized || mtds.GetMsgStatus() == 0) {
		/* Nothing in the queue, so we're done.
		*/
		return;
	}

	/* There is something in the queue. See what we have.
	*/
	mtds.GetMsg((MEVT *)&mtch);
#if !defined(__SIM__)
#if defined(__MTDSTRACE__)
	xil_printf("MTCH: tms = ");
	xil_printf(mtch.tms, DEC);
	xil_printf(" hwin = ");
	xil_printf(mtch.hwin, HEX);
	xil_printf(" msg = ");
	xil_printfln(mtch.msg, HEX);
	xil_printf("  xco = ");
	xil_printf(mtch.xco, DEC);
	xil_printf(" yco = ");
	xil_printf(mtch.yco, DEC);
	xil_printf(" wgt = ");
	xil_printf(mtch.wgt, DEC);
	xil_printf(" spd = ");
	xil_printf(mtch.spd, DEC);
#endif
#endif

	if ((mtch.msg < msgFingerFirst) || (mtch.msg > msgFingerLast)) {
		/* This library assumes that there is not anything of interest in the queue
		** other than touch messages. It throws away any messages seen except
		** touch messages.
		*/
		return;
	}

	/* It is a touch message.
	** First, update the finger tracking structures.
	*/
	if ((mtch.msg >= msgFinger1Down) && (mtch.msg <= msgFinger1Up)) {
		rgfng[0].x = mtch.xco;
		rgfng[0].y = mtch.yco;
		if (mtch.msg == msgFinger1Down) {
			rgfng[0].st = FINGER_DOWN;
		}
		else if (mtch.msg == msgFinger1Move) {
			rgfng[0].st = FINGER_MOVE;
		}
		else {
			rgfng[0].st = FINGER_UP;
		}
	}

	if ((mtch.msg >= msgFinger2Down) && (mtch.msg <= msgFinger2Up)) {
		rgfng[1].x = mtch.xco;
		rgfng[1].y = mtch.yco;
		if (mtch.msg == msgFinger2Down) {
			rgfng[1].st = FINGER_DOWN;
		}
		else if (mtch.msg == msgFinger2Move) {
			rgfng[1].st = FINGER_MOVE;
		}
		else {
			rgfng[1].st = FINGER_UP;
		}
	}

void paint();
void test();

int main() {
	setup();
	while (1) {
		paint();
	}
	return 0;
}

void paint() {
//   mydisp.clearDisplay(clrBlack);

	test();
	usleep(100000);
}

void test() {

}
